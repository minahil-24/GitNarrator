// ppt-generator.js

const PPTGenerator = {
    generate: async (data, treeData) => {
        if (typeof PptxGenJS === 'undefined') {
            alert("PptxGenJS library not found.");
            return;
        }

        const pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        pptx.author = 'RepoMind AI';
        pptx.company = 'RepoMind';
        pptx.subject = `Analysis of ${data.repo}`;

        // --- THEME & STYLES ---
        const theme = {
            bg: "0d1117",      // Darker GitHub BG
            fg: "c9d1d9",      // Primary Text
            accent: "58a6ff",  // GitHub Blue
            secondary: "8b949e", // Muted
            codeBg: "161b22",  // Code Block BG
            headerFont: "Segoe UI",
            bodyFont: "Arial"
        };

        const addMasterSlide = () => {
            pptx.defineSlideMaster({
                title: "MASTER_SLIDE",
                background: { color: theme.bg },
                objects: [
                    // Header Bar
                    { rect: { x: 0, y: 0, w: '100%', h: 0.15, fill: theme.accent } },
                    // Footer Bar
                    { line: { x: 0.5, y: 6.8, w: '90%', h: 0, line: theme.secondary, lineSize: 1 } },
                    { text: { text: "Generated by GitNarrator", x: 0.5, y: 6.9, fontSize: 10, color: theme.secondary } },
                    { text: { text: data.repo, x: 10, y: 6.9, fontSize: 10, color: theme.secondary, align: 'right' } }
                ]
            });
        };
        addMasterSlide();

        const createSlide = (title, subtitle = "") => {
            let slide = pptx.addSlide({ masterName: "MASTER_SLIDE" });
            slide.addText(title, { x: 0.5, y: 0.5, fontSize: 28, fontFace: theme.headerFont, color: theme.accent, bold: true });
            if (subtitle) {
                slide.addText(subtitle, { x: 0.5, y: 1.0, fontSize: 14, color: theme.secondary, italic: true });
            }
            return slide;
        };

        // --- 1. TITLE SLIDE ---
        let sTitle = pptx.addSlide();
        sTitle.background = { color: theme.bg };
        // Decorative Shapes
        sTitle.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: '40%', h: '100%', fill: '161b22' });
        sTitle.addText(data.repo, { x: 0.5, y: 2.5, w: '35%', fontSize: 32, color: "FFFFFF", bold: true, align: "left" });
        sTitle.addText("Repository Analysis & Architecture Review", { x: 0.5, y: 3.5, w: '35%', fontSize: 18, color: theme.accent });
        sTitle.addText(`Date: ${new Date().toLocaleDateString()}`, { x: 0.5, y: 6.5, fontSize: 12, color: theme.secondary });

        // Stats on Title Slide (Right Side)
        const statBoxConfig = { x: 5.5, w: 2, h: 1.5, fill: theme.codeBg, align: 'center', color: theme.fg };
        sTitle.addText(`â­ ${data.stats.stars}\nStars`, { ...statBoxConfig, y: 2, fontSize: 16 });
        sTitle.addText(`ðŸ´ ${data.stats.forks}\nForks`, { ...statBoxConfig, y: 2, x: 7.6 });
        sTitle.addText(`ðŸž ${data.stats.issues}\nIssues`, { ...statBoxConfig, y: 4, fontSize: 16 });
        if (data.stats.contributors) {
            sTitle.addText(`ðŸ‘¥ ${data.stats.contributors}\nContributors`, { ...statBoxConfig, y: 4, x: 7.6 });
        }


        // --- 2. EXECUTIVE SUMMARY (AI) ---
        let sExec = createSlide("Executive Summary");
        let summaryPrompt = `Summarize the repository ${data.repo} (${data.description}) in 3 professional bullet points highlighting its purpose and potential impact.`;
        let summaryText = await AIService.generate(summaryPrompt) ||
            `â€¢ The repository ${data.repo} is a software project focused on ${data.description || 'solving specific problems'}.\n` +
            `â€¢ It utilizes a modern tech stack to achieve its goals.\n` +
            `â€¢ Active development is indicated by ${data.stats.commits || 'recent activity'}.`;

        // Clean markdown
        summaryText = summaryText.replace(/\*\*/g, "").replace(/- /g, "â€¢ ");

        sExec.addText(summaryText, { x: 0.5, y: 1.5, w: '90%', fontSize: 18, color: theme.fg, lineSpacing: 32 });


        // --- 3. ARCHITECTURE & STRUCTURE ---
        let sArch = createSlide("Project Structure");
        // We can't easily put the mermaid graph here without converting to image, 
        // but we can list the top level modules.
        let topLevel = treeData && treeData.tree ? treeData.tree
            .filter(i => i.type === 'tree' && !i.path.includes('/')) // Root folders
            .map(i => "ðŸ“‚ " + i.path)
            .join("\n") : "No structure data.";

        sArch.addText("Top-Level Modules:", { x: 0.5, y: 1.5, fontSize: 16, color: theme.accent });
        sArch.addText(topLevel, { x: 0.5, y: 2.0, w: '40%', fontSize: 14, color: theme.fg });

        // AI Architectural Insight
        sArch.addText("Architectural Insights:", { x: 5, y: 1.5, fontSize: 16, color: theme.accent });
        let archInsight = await AIService.generate(`Based on these folders: ${topLevel}, explain the likely architecture pattern (e.g. MVC, Monorepo, Microservices).`)
            || "Standard modular structure.";
        sArch.addText(archInsight, { x: 5, y: 2.0, w: '45%', fontSize: 14, color: theme.fg, italic: true });


        // --- 4. KEY FILES ANALYSIS ---
        // Pick interesting files
        let interestingFiles = [];
        if (treeData && treeData.tree) {
            // Prioritize large source files, ignore configs/tests for this deep dive
            interestingFiles = treeData.tree
                .filter(f => f.type === 'blob' && (f.path.match(/\.(js|ts|py|java|go|rs|cpp)$/)))
                .filter(f => !f.path.includes('test') && !f.path.includes('config') && !f.path.includes('.d.ts'))
                .slice(0, 3); // Top 3
        }

        for (const file of interestingFiles) {
            let sFile = createSlide(`Deep Dive: ${file.path.split('/').pop()}`, file.path);

            try {
                const content = await ghApi.getFileContent(data.owner, data.name, file.path);
                const explanation = await CodeAnalyzer.analyze(file.path, content.substring(0, 3000), "advanced");

                // Left col: Code Snippet (first 10 lines)
                sFile.addText(content.split('\n').slice(0, 15).join('\n'), {
                    x: 0.5, y: 1.5, w: '40%', h: 4.5,
                    fontSize: 10, fontFace: "Courier New", color: "e6edf3",
                    rect: { fill: theme.codeBg, color: theme.border }
                });

                // Right col: Explanation
                sFile.addText(explanation, { x: 5, y: 1.5, w: '45%', h: 4.5, fontSize: 14, color: theme.fg, valign: 'top' });

            } catch (e) {
                sFile.addText("Error content unavailable.", { x: 0.5, y: 2 });
            }
        }

        // --- 5. ROADMAP & RECOMMENDATIONS ---
        let sRoadmap = createSlide("Strategic Recommendations");
        let roadmapPrompt = `Suggest 3 strategic technical improvements for a project using ${Object.keys(data.languages || {}).join(', ')}. Focus on scalability and security.`;
        let roadmap = await AIService.generate(roadmapPrompt) ||
            "â€¢ Implement comprehensive unit and integration testing.\nâ€¢ Set up CI/CD pipelines for automated delivery.\nâ€¢ Conduct a security audit of dependencies.";

        sRoadmap.addText(roadmap, { x: 0.5, y: 1.5, w: '90%', fontSize: 16, color: theme.fg });

        // --- END ---
        pptx.writeFile({ fileName: `GitNarrator-${data.repo.replace('/', '-')}.pptx` });
    }
};
